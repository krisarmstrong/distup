# =============================================================================
# distup CI Pipeline
# Runs on every push and pull request
# =============================================================================

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint & Validate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install ShellCheck
        run: sudo apt-get install -y shellcheck

      - name: Install shfmt
        run: |
          curl -sS https://webi.sh/shfmt | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Run ShellCheck
        run: |
          echo "Running ShellCheck on all scripts..."
          shellcheck -x -s bash upgrade-*.sh
          echo "✅ ShellCheck passed"

      - name: Check formatting with shfmt
        run: |
          echo "Checking script formatting..."
          shfmt -i 4 -ci -d upgrade-*.sh
          echo "✅ Formatting check passed"

      - name: Validate script syntax
        run: |
          echo "Validating bash syntax..."
          for script in upgrade-*.sh; do
            bash -n "$script"
            echo "✅ $script syntax OK"
          done

  test:
    name: Test Scripts
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Test --help flags
        run: |
          echo "Testing help/usage output..."
          for script in upgrade-*.sh; do
            chmod +x "$script"
            # Scripts that support --help
            if grep -q "\-\-help" "$script"; then
              ./"$script" --help || true
              echo "✅ $script --help works"
            fi
          done

      - name: Test invalid arguments
        run: |
          echo "Testing invalid argument handling..."
          for script in upgrade-*.sh; do
            chmod +x "$script"
            # Should exit non-zero for invalid args (but not crash)
            if ./"$script" --invalid-arg 2>&1 | grep -qi "invalid\|error\|usage"; then
              echo "✅ $script handles invalid args"
            fi
          done
